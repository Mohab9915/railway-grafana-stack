# Loki runtime configuration for parsing structured JSON logs from Fawri backend
overrides:
  # Override for Railway's built-in log ingestion
  tenant_id: "service"

  # Increase ingestion limits for structured JSON logs
  ingestion_rate_mb: 16
  ingestion_burst_size_mb: 32

# Add a parsing stage for structured JSON logs from Fawri backend
# This will be used when Railway forwards logs to Loki
pipeline_stages:
  # Parse JSON logs from Fawri backend
  - json:
      expressions:
        # Extract fields from structured_logging.py output
        level: level
        message: message
        service: service
        user_id: user_id
        endpoint: endpoint
        http_method: http_method
        status_code: status_code
        duration_ms: duration_ms
        db_operation: db_operation
        db_table: db_table
        rows_affected: rows_affected
        error_type: error_type
        error_message: error_message
        version: version
        environment: environment
        memory_mb: memory_mb
        threshold_mb: threshold_mb

  # Add labels from structured logs for better querying in Grafana
  - labels:
      level:
      service:
      http_method:
      db_operation:
      error_type

  # Parse timestamp from structured logs if present, otherwise use ingestion time
  - timestamp:
      format: RFC3339
      source: timestamp
      fallback_ingestion_time: true

  # Create output line with extracted fields
  - output:
      source: message